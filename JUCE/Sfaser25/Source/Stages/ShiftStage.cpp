/*
  ==============================================================================

    shiftStage.cpp
    Created: 1 May 2023 6:03:45pm
    Author:  Samuele Del Moro

  ==============================================================================
*/
#pragma once

#include "ShiftStage.h"
#include <cmath>

ShiftStage::ShiftStage() {

    //Qv_T << 1, 0, 0, 0,
    //    0, 1, 0, 0,
    //    0, 0, 1, 0,
    //    0, 0, 0, 1,
    //    0, 0, 0, 1,
    //    0, 1, 0, 0,
    //    -1, 0, -1, -1,
    //    -1, -1, 0, -1;
    //Qv = Qv_T.transpose();

    //Qi_T << 1, 0, 0, 0,
    //    0, 1, 0, 0,
    //    0, 0, 1, 0,
    //    0, 0, 0, 1,
    //    -1, 0, -1, 0,
    //    0, 1, 0, 0,
    //    0, 0, 0, 0,
    //    -1, -1, 0, -1;

    //Qi = Qi_T.transpose();

    //I = Matrix8d::Identity(8, 8);
    //I4 = Matrix4d::Identity(4, 4);
    //Z.fill(0);
    //S1.fill(0);
}

void ShiftStage::prepareShiftStage(float sampleRate)
{
    float Ts = 1/sampleRate;

    Z4 = Ts / (2 * 47e-9);
    //Matrix<double, 8, 1> z(Z1, Z2, Z3, Z4, Z5, Z6, Z7, Z8);
    //Z = z.asDiagonal();
    ///*Matrix8d S = 2 * Qv_T * (Qi * Z.inverse() * Qv_T).inverse() * (Qi * Z.inverse()) - I;*/
    ////Matrix8d S;
}

float ShiftStage::shiftStageSample(float inputSample, wavesSTAGE& waves, float LFO)
{
    Z6 = 1 / (k * (LFO - Vref - Vp));
    
    shiftMatrix(Z4, Z6);
    waves.a[0] = -inputSample;
    waves.a[3] = waves.b(3);
    waves.a[7] = 5.1;
    waves.b = S1 * waves.a;
    
    float outputSample = ((waves.a[6]+waves.b[6])/2);
    return outputSample;

}

void ShiftStage::shiftMatrix(float Z4, float Z6)
{
    //S1(0, 0) = (64 * (3391812500141 * Z6 + 187500003384000)) / (108538000009049 * Z6 + 6000000217176000) - 1;
    //S1(0, 1) = -(9074 * Z6) / (108538000009049 * Z6 + 6000000217176000);
    //S1(0, 2) = 0;
    //S1(0, 3) = (423 * (4666666667 * Z6 - 79999999992000)) / (156250000 * (108538000009049 * Z6 + 6000000217176000));
    //S1(0, 4) = -(3391812500141 * Z6 + 187500003384000) / (156250000 * (108538000009049 * Z6 + 6000000217176000));
    //S1(0, 5) = -217776000 / (108538000009049 * Z6 + 6000000217176000);
    //S1(0, 6) = 0;
    //S1(0, 7) = -(9074 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(1, 0) = -(216576000000000 * Z6) / (108538000009049 * Z6 + 6000000217176000);
    //S1(1, 1) = (500000018098 * Z6) / (108538000009049 * Z6 + 6000000217176000) - 1;
    //S1(1, 2) = 0;
    //S1(1, 3) = -(1082880000108288 * Z6) / (5 * (108538000009049 * Z6 + 6000000217176000));
    //S1(1, 4) = (108288 * Z6) / (5 * (108538000009049 * Z6 + 6000000217176000));
    //S1(1, 5) = 12000000434352000 / (108538000009049 * Z6 + 6000000217176000);
    //S1(1, 6) = 0;
    //S1(1, 7) = -(216576000000000 * Z6) / (108538000009049 * Z6 + 6000000217176000);
    //S1(2, 0) = -(500000000000 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(2, 1) = -(500000000000 * Z6) / (108538000009049 * Z6 + 6000000217176000);
    //S1(2, 2) = 1;
    //S1(2, 3) = (18048 * (12000000001 * Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(2, 4) = -(128 * (1695906250141 * Z6 + 93750003384000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(2, 5) = -12000000000000000 / (108538000009049 * Z6 + 6000000217176000);
    //S1(2, 6) = 0;
    //S1(2, 7) = -(500000000000 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(3, 0) = -(500000000000 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(3, 1) = -(500000000000 * Z6) / (108538000009049 * Z6 + 6000000217176000);
    //S1(3, 2) = 0;
    //S1(3, 3) = (18048 * (12000000001 * Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000) - 1;
    //S1(3, 4) = (50 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(3, 5) = -12000000000000000 / (108538000009049 * Z6 + 6000000217176000);
    //S1(3, 6) = 0;
    //S1(3, 7) = -(500000000000 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(4, 0) = -(500000000000 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(4, 1) = -(500000000000 * Z6) / (108538000009049 * Z6 + 6000000217176000);
    //S1(4, 2) = 0;
    //S1(4, 3) = (18048 * (12000000001 * Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(4, 4) = (50 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000) - 1;
    //S1(4, 5) = -12000000000000000 / (108538000009049 * Z6 + 6000000217176000);
    //S1(4, 6) = 0;
    //S1(4, 7) = -(500000000000 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(5, 0) = -(216576000000000 * Z6) / (108538000009049 * Z6 + 6000000217176000);
    //S1(5, 1) = (500000018098 * Z6) / (108538000009049 * Z6 + 6000000217176000);
    //S1(5, 2) = 0;
    //S1(5, 3) = -(1082880000108288 * Z6) / (5 * (108538000009049 * Z6 + 6000000217176000));
    //S1(5, 4) = (108288 * Z6) / (5 * (108538000009049 * Z6 + 6000000217176000));
    //S1(5, 5) = 12000000434352000 / (108538000009049 * Z6 + 6000000217176000) - 1;
    //S1(5, 6) = 0;
    //S1(5, 7) = -(216576000000000 * Z6) / (108538000009049 * Z6 + 6000000217176000);
    //S1(6, 0) = (1000000000000 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000) - (64 * (3391812500141 * Z6 + 187500003384000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(6, 1) = (1000000009074 * Z6) / (108538000009049 * Z6 + 6000000217176000);
    //S1(6, 2) = -2;
    //S1(6, 3) = -(423 * (4666666667 * Z6 - 79999999992000)) / (156250000 * (108538000009049 * Z6 + 6000000217176000)) - (36096 * (12000000001 * Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(6, 4) = (3391812500141 * Z6 + 187500003384000) / (156250000 * (108538000009049 * Z6 + 6000000217176000)) - (50 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000) + (128 * (1695906250141 * Z6 + 93750003384000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(6, 5) = 24000000217776000 / (108538000009049 * Z6 + 6000000217176000);
    //S1(6, 6) = -1;
    //S1(6, 7) = (1000000009074 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(7, 0) = (216576000000000 * Z6) / (108538000009049 * Z6 + 6000000217176000) - (64 * (3391812500141 * Z6 + 187500003384000)) / (108538000009049 * Z6 + 6000000217176000) + (500000000000 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(7, 1) = -(9024 * Z6) / (108538000009049 * Z6 + 6000000217176000);
    //S1(7, 2) = 0;
    //S1(7, 3) = (1082880000108288 * Z6) / (5 * (108538000009049 * Z6 + 6000000217176000)) - (423 * (4666666667 * Z6 - 79999999992000)) / (156250000 * (108538000009049 * Z6 + 6000000217176000)) - (18048 * (12000000001 * Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(7, 4) = (3391812500141 * Z6 + 187500003384000) / (156250000 * (108538000009049 * Z6 + 6000000217176000)) - (108288 * Z6) / (5 * (108538000009049 * Z6 + 6000000217176000)) - (50 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000);
    //S1(7, 5) = -216576000 / (108538000009049 * Z6 + 6000000217176000);
    //S1(7, 6) = 0;
    //S1(7, 7) = (216576000000000 * Z6) / (108538000009049 * Z6 + 6000000217176000) + (500000009074 * (Z6 + 24000)) / (108538000009049 * Z6 + 6000000217176000) - 1;

    S1(0, 0) = (20000 * (24000000000 * Z4 + 24000000001 * Z6 + 1000000 * Z4 * Z6 + 24000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - 1;
    S1(0, 1) = -(2 * (10000 * Z6 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(0, 2) = 0;
    S1(0, 3) = (3 * (4666666667 * Z6 - 79999999992000)) / (500000 * (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000));
    S1(0, 4) = -(24000000000 * Z4 + 24000000001 * Z6 + 1000000 * Z4 * Z6 + 24000) / (500000 * (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000));
    S1(0, 5) = -(48000 * (Z4 + 10000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(0, 6) = 0;
    S1(0, 7) = -(2 * (24000 * Z4 + 10000 * Z6 + Z4 * Z6 + 240000000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(1, 0) = -(480000000000000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(1, 1) = (2 * Z6 * (10000000001 * Z4 + 20000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - 1;
    S1(1, 2) = 0;
    S1(1, 3) = -(480000000048000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(1, 4) = (48000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(1, 5) = (48000 * (10000000001 * Z4 + 20000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(1, 6) = 0;
    S1(1, 7) = -(480000000000000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(2, 0) = -(20000000000 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(2, 1) = -(20000000000 * Z4 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(2, 2) = 1;
    S1(2, 3) = (40000 * (12000000001 * Z6 + 24000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(2, 4) = -(40000 * (12000000000 * Z4 + 12000000001 * Z6 + 500000 * Z4 * Z6 + 24000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(2, 5) = -(480000000000000 * Z4) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(2, 6) = 0;
    S1(2, 7) = -(20000000000 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(3, 0) = -(20000000000 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(3, 1) = -(20000000000 * Z4 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(3, 2) = 0;
    S1(3, 3) = (40000 * (12000000001 * Z6 + 24000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - 1;
    S1(3, 4) = (2 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(3, 5) = -(480000000000000 * Z4) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(3, 6) = 0;
    S1(3, 7) = -(20000000000 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(4, 0) = -(20000000000 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(4, 1) = -(20000000000 * Z4 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(4, 2) = 0;
    S1(4, 3) = (40000 * (12000000001 * Z6 + 24000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(4, 4) = (2 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - 1;
    S1(4, 5) = -(480000000000000 * Z4) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(4, 6) = 0;
    S1(4, 7) = -(20000000000 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(5, 0) = -(480000000000000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(5, 1) = (2 * Z6 * (10000000001 * Z4 + 20000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(5, 2) = 0;
    S1(5, 3) = -(480000000048000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(5, 4) = (48000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(5, 5) = (48000 * (10000000001 * Z4 + 20000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - 1;
    S1(5, 6) = 0;
    S1(5, 7) = -(480000000000000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(6, 0) = (40000000000 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - (20000 * (24000000000 * Z4 + 24000000001 * Z6 + 1000000 * Z4 * Z6 + 24000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(6, 1) = (2 * (10000 * Z6 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) + (40000000000 * Z4 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(6, 2) = -2;
    S1(6, 3) = -(3 * (4666666667 * Z6 - 79999999992000)) / (500000 * (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000)) - (80000 * (12000000001 * Z6 + 24000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(6, 4) = (40000 * (12000000000 * Z4 + 12000000001 * Z6 + 500000 * Z4 * Z6 + 24000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) + (24000000000 * Z4 + 24000000001 * Z6 + 1000000 * Z4 * Z6 + 24000) / (500000 * (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000)) - (2 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(6, 5) = (960000000000000 * Z4) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) + (48000 * (Z4 + 10000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(6, 6) = -1;
    S1(6, 7) = (2 * (24000 * Z4 + 10000 * Z6 + Z4 * Z6 + 240000000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) + (40000000000 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(7, 0) = (480000000000000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - (20000 * (24000000000 * Z4 + 24000000001 * Z6 + 1000000 * Z4 * Z6 + 24000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) + (20000000000 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(7, 1) = (2 * (10000 * Z6 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) + (20000000000 * Z4 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - (2 * Z6 * (10000000001 * Z4 + 20000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(7, 2) = 0;
    S1(7, 3) = (480000000048000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - (3 * (4666666667 * Z6 - 79999999992000)) / (500000 * (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000)) - (40000 * (12000000001 * Z6 + 24000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(7, 4) = (24000000000 * Z4 + 24000000001 * Z6 + 1000000 * Z4 * Z6 + 24000) / (500000 * (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000)) - (48000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - (2 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(7, 5) = (480000000000000 * Z4) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - (48000 * (10000000001 * Z4 + 20000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) + (48000 * (Z4 + 10000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000);
    S1(7, 6) = 0;
    S1(7, 7) = (480000000000000 * Z6) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) + (2 * (24000 * Z4 + 10000 * Z6 + Z4 * Z6 + 240000000)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) + (20000000000 * (24000 * Z4 + Z4 * Z6)) / (240000000024000 * Z4 + 240000000020000 * Z6 + 10000000001 * Z4 * Z6 + 480000000) - 1;
}



